// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String     @id @default(cuid())
  email     String     @unique
  name      String
  password  String
  roles     UserRole[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@map("user")
}

model Role {
  id          String           @id @default(cuid())
  name        String           @unique
  description String?
  permissions RolePermission[]
  users       UserRole[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@map("role")
}

model Permission {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  action      String
  resourceId  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  resource        Resource         @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  rolePermissions RolePermission[]

  @@map("permission")
}

model UserRole {
  id        String   @id @default(cuid())
  userId    String
  roleId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, roleId])
  @@map("user_role")
}

model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())

  @@unique([roleId, permissionId])
  @@map("role_permission")
}

model Site {
  id        String   @id @default(uuid())
  name      String   @unique
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  engins     Engin[]
  saisiehrms Saisiehrm[]
  objectifs  Objectif[]

  @@map("sites")
}

model Resource {
  id        String   @id @default(cuid())
  name      String   @unique
  label     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  permissions Permission[]

  @@map("resource")
}

model Typeparc {
  id   Int    @id @default(autoincrement())
  name String @unique

  // Relations
  parcs Parc[]

  @@map("typeparc")
}

model Parc {
  id         Int      @id @default(autoincrement())
  name       String   @unique
  typeparcId Int
  typeparc   Typeparc @relation(fields: [typeparcId], references: [id], onDelete: Restrict)

  // Relations
  engins               Engin[]
  typesConsommationLub TypeconsommationlubParc[]
  typepanneParc        TypepanneParc[]
  lubrifiantParc       LubrifiantParc[]
  objectifs            Objectif[]

  @@map("parc")
}

model Typeconsommationlub {
  id   Int    @id @default(autoincrement())
  name String @unique

  // Relations
  parcs             TypeconsommationlubParc[]
  saisielubrifiants Saisielubrifiant[]

  @@map("typeconsommationlub")
}

model TypeconsommationlubParc {
  parcId                Int
  typeconsommationlubId Int
  parc                  Parc                @relation(fields: [parcId], references: [id], onDelete: Restrict)
  typeconsommationlub   Typeconsommationlub @relation(fields: [typeconsommationlubId], references: [id], onDelete: Restrict)

  @@id([parcId, typeconsommationlubId])
  @@map("typeconsommationlub_parc")
}

model Lubrifiant {
  id               Int            @id @default(autoincrement())
  name             String         @unique
  typelubrifiantId Int
  typelubrifiant   Typelubrifiant @relation(fields: [typelubrifiantId], references: [id], onDelete: Restrict)

  // Relations
  saisielubrifiants Saisielubrifiant[]
  lubrifiantParcs   LubrifiantParc[]

  @@map("lubrifiant")
}

model LubrifiantParc {
  parcId       Int
  lubrifiantId Int
  parc         Parc       @relation(fields: [parcId], references: [id], onDelete: Restrict)
  lubrifiant   Lubrifiant @relation(fields: [lubrifiantId], references: [id], onDelete: Restrict)

  @@id([parcId, lubrifiantId])
  @@map("lubrifiant_parc")
}

model Engin {
  id                  Int     @id @default(autoincrement())
  name                String  @unique
  active              Boolean @default(true)
  parcId              Int
  siteId              String
  initialHeureChassis Float?  @default(0)

  // Relations
  parc       Parc        @relation(fields: [parcId], references: [id], onDelete: Restrict)
  site       Site        @relation(fields: [siteId], references: [id], onDelete: Restrict)
  saisiehrms Saisiehrm[]
  saisiehim  Saisiehim[]

  @@map("engin")
}

model Typepanne {
  id   Int    @id @default(autoincrement())
  name String @unique

  // Relations
  pannes        Panne[]
  typepanneParc TypepanneParc[]

  @@map("typepanne")
}

model TypepanneParc {
  parcId      Int
  typepanneId Int
  parc        Parc      @relation(fields: [parcId], references: [id], onDelete: Restrict)
  typepanne   Typepanne @relation(fields: [typepanneId], references: [id], onDelete: Restrict)

  @@id([parcId, typepanneId])
  @@map("typepanne_parc")
}

model Panne {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  typepanneId Int
  typepanne   Typepanne @relation(fields: [typepanneId], references: [id], onDelete: Restrict)

  // Relations
  saisiehim Saisiehim[]

  @@map("panne")
}

model Saisiehrm {
  id      Int      @id @default(autoincrement())
  du      DateTime
  enginId Int
  siteId  String
  hrm     Float

  // Relations
  engin     Engin       @relation(fields: [enginId], references: [id], onDelete: Restrict)
  site      Site        @relation(fields: [siteId], references: [id], onDelete: Restrict)
  saisiehim Saisiehim[]

  @@unique([du, enginId])
  @@map("saisiehrm")
}

model Saisiehim {
  id          Int     @id @default(autoincrement())
  panneId     Int
  him         Float
  ni          Int
  saisiehrmId Int
  enginId     Int?
  obs         String?

  // Relations
  panne             Panne              @relation(fields: [panneId], references: [id], onDelete: Restrict)
  saisiehrm         Saisiehrm          @relation(fields: [saisiehrmId], references: [id], onDelete: Restrict)
  engin             Engin?             @relation(fields: [enginId], references: [id], onDelete: Restrict)
  saisielubrifiants Saisielubrifiant[]

  @@unique([panneId, saisiehrmId])
  @@map("saisiehim")
}

model Typelubrifiant {
  id   Int    @id @default(autoincrement())
  name String @unique

  // Relations
  lubrifiants Lubrifiant[]

  @@map("typelubrifiant")
}

model Saisielubrifiant {
  id                    Int     @id @default(autoincrement())
  lubrifiantId          Int
  qte                   Float
  obs                   String?
  saisiehimId           Int
  typeconsommationlubId Int?

  // Relations
  lubrifiant          Lubrifiant           @relation(fields: [lubrifiantId], references: [id], onDelete: Restrict)
  saisiehim           Saisiehim            @relation(fields: [saisiehimId], references: [id], onDelete: Restrict)
  typeconsommationlub Typeconsommationlub? @relation(fields: [typeconsommationlubId], references: [id], onDelete: Restrict)

  @@map("saisielubrifiant")
}

model Objectif {
  id          Int    @id @default(autoincrement())
  annee       Int
  parcId      Int
  siteId      String
  dispo       Float?
  mtbf        Float?
  tdm         Float?
  spe_huile   Float?
  spe_go      Float?
  spe_graisse Float?

  // Relations
  parc Parc @relation(fields: [parcId], references: [id], onDelete: Restrict)
  site Site @relation(fields: [siteId], references: [id], onDelete: Restrict)

  @@unique([annee, parcId, siteId])
  @@map("objectif")
}
